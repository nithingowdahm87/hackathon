apiVersion: v1
kind: Namespace
metadata:
  name: urbanops
---
apiVersion: v1
kind: Namespace
metadata:
  name: ingress-nginx
---
apiVersion: v1
kind: Secret
metadata:
  name: postgres-secret
  namespace: urbanops
type: Opaque
stringData:
  POSTGRES_DB: urbanops
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: postgres
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres
  namespace: urbanops
  labels:
    app: postgres
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
        - name: postgres
          image: postgres:15-alpine
          ports:
            - containerPort: 5432
          env:
            - name: POSTGRES_DB
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_DB
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_USER
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_PASSWORD
          readinessProbe:
            exec:
              command: ["pg_isready", "-U", "postgres"]
            initialDelaySeconds: 10
            periodSeconds: 10
          volumeMounts:
            - mountPath: /var/lib/postgresql/data
              name: postgres-storage
      volumes:
        - name: postgres-storage
          emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: postgres
  namespace: urbanops
spec:
  selector:
    app: postgres
  ports:
    - port: 5432
      targetPort: 5432
---
# gateway-service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gateway-service
  namespace: urbanops
  labels:
    app: gateway-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: gateway-service
  template:
    metadata:
      labels:
        app: gateway-service
    spec:
      containers:
        - name: gateway-service
          image: nithingowdahm87/hackathon-gateway-service:latest
          ports:
            - containerPort: 8081
          env:
            - name: SPRING_PROFILES_ACTIVE
              value: docker
            - name: SPRING_DATASOURCE_URL
              value: jdbc:postgresql://postgres.urbanops.svc.cluster.local:5432/urbanops
            - name: SPRING_DATASOURCE_USERNAME
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_USER
            - name: SPRING_DATASOURCE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_PASSWORD
---
apiVersion: v1
kind: Service
metadata:
  name: gateway-service
  namespace: urbanops
spec:
  selector:
    app: gateway-service
  ports:
    - port: 8081
      targetPort: 8081
---
# auth-service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: auth-service
  namespace: urbanops
  labels:
    app: auth-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: auth-service
  template:
    metadata:
      labels:
        app: auth-service
    spec:
      containers:
        - name: auth-service
          image: nithingowdahm87/hackathon-auth-service:latest
          ports:
            - containerPort: 8090
          env:
            - name: SPRING_PROFILES_ACTIVE
              value: docker
            - name: SPRING_DATASOURCE_URL
              value: jdbc:postgresql://postgres.urbanops.svc.cluster.local:5432/urbanops
            - name: SPRING_DATASOURCE_USERNAME
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_USER
            - name: SPRING_DATASOURCE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_PASSWORD
---
apiVersion: v1
kind: Service
metadata:
  name: auth-service
  namespace: urbanops
spec:
  selector:
    app: auth-service
  ports:
    - port: 8090
      targetPort: 8090
---
# alert-service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: alert-service
  namespace: urbanops
  labels:
    app: alert-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: alert-service
  template:
    metadata:
      labels:
        app: alert-service
    spec:
      containers:
        - name: alert-service
          image: nithingowdahm87/hackathon-alert-service:latest
          ports:
            - containerPort: 8091
          env:
            - name: SPRING_PROFILES_ACTIVE
              value: docker
            - name: SPRING_DATASOURCE_URL
              value: jdbc:postgresql://postgres.urbanops.svc.cluster.local:5432/urbanops
            - name: SPRING_DATASOURCE_USERNAME
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_USER
            - name: SPRING_DATASOURCE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_PASSWORD
---
apiVersion: v1
kind: Service
metadata:
  name: alert-service
  namespace: urbanops
spec:
  selector:
    app: alert-service
  ports:
    - port: 8091
      targetPort: 8091
---
# cctv-service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cctv-service
  namespace: urbanops
  labels:
    app: cctv-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: cctv-service
  template:
    metadata:
      labels:
        app: cctv-service
    spec:
      containers:
        - name: cctv-service
          image: nithingowdahm87/hackathon-cctv-service:latest
          ports:
            - containerPort: 8094
          env:
            - name: SPRING_PROFILES_ACTIVE
              value: docker
            - name: SPRING_DATASOURCE_URL
              value: jdbc:postgresql://postgres.urbanops.svc.cluster.local:5432/urbanops
            - name: SPRING_DATASOURCE_USERNAME
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_USER
            - name: SPRING_DATASOURCE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_PASSWORD
---
apiVersion: v1
kind: Service
metadata:
  name: cctv-service
  namespace: urbanops
spec:
  selector:
    app: cctv-service
  ports:
    - port: 8094
      targetPort: 8094
---
# power-service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: power-service
  namespace: urbanops
  labels:
    app: power-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: power-service
  template:
    metadata:
      labels:
        app: power-service
    spec:
      containers:
        - name: power-service
          image: nithingowdahm87/hackathon-power-service:latest
          ports:
            - containerPort: 8093
          env:
            - name: SPRING_PROFILES_ACTIVE
              value: docker
            - name: SPRING_DATASOURCE_URL
              value: jdbc:postgresql://postgres.urbanops.svc.cluster.local:5432/urbanops
            - name: SPRING_DATASOURCE_USERNAME
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_USER
            - name: SPRING_DATASOURCE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_PASSWORD
---
apiVersion: v1
kind: Service
metadata:
  name: power-service
  namespace: urbanops
spec:
  selector:
    app: power-service
  ports:
    - port: 8093
      targetPort: 8093
---
# traffic-service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: traffic-service
  namespace: urbanops
  labels:
    app: traffic-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: traffic-service
  template:
    metadata:
      labels:
        app: traffic-service
    spec:
      containers:
        - name: traffic-service
          image: nithingowdahm87/hackathon-traffic-service:latest
          ports:
            - containerPort: 8092
          env:
            - name: SPRING_PROFILES_ACTIVE
              value: docker
            - name: SPRING_DATASOURCE_URL
              value: jdbc:postgresql://postgres.urbanops.svc.cluster.local:5432/urbanops
            - name: SPRING_DATASOURCE_USERNAME
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_USER
            - name: SPRING_DATASOURCE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_PASSWORD
---
apiVersion: v1
kind: Service
metadata:
  name: traffic-service
  namespace: urbanops
spec:
  selector:
    app: traffic-service
  ports:
    - port: 8092
      targetPort: 8092
---
# python-service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: python-service
  namespace: urbanops
  labels:
    app: python-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: python-service
  template:
    metadata:
      labels:
        app: python-service
    spec:
      containers:
        - name: python-service
          image: nithingowdahm87/hackathon-python-service:latest
          ports:
            - containerPort: 8000
          env:
            - name: DATABASE_URL
              value: postgresql://postgres:postgres@postgres.urbanops.svc.cluster.local:5432/urbanops
            - name: WEATHER_API_URL
              value: https://api.open-meteo.com/v1/forecast
            - name: BACKEND_API_URL
              value: http://gateway-service.urbanops.svc.cluster.local:8081/api/predictions
---
apiVersion: v1
kind: Service
metadata:
  name: python-service
  namespace: urbanops
spec:
  selector:
    app: python-service
  ports:
    - port: 8000
      targetPort: 8000
---
# frontend
apiVersion: v1
kind: ConfigMap
metadata:
  name: frontend-config
  namespace: urbanops
data:
  config.json: |
    {
      "API_URL": "/api"
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
  namespace: urbanops
  labels:
    app: frontend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      containers:
        - name: frontend
          image: nithingowdahm87/hackathon-frontend:latest
          ports:
            - containerPort: 80
          volumeMounts:
            - name: config
              mountPath: /usr/share/nginx/html/config.json
              subPath: config.json
      volumes:
        - name: config
          configMap:
            name: frontend-config
---
apiVersion: v1
kind: Service
metadata:
  name: frontend
  namespace: urbanops
spec:
  selector:
    app: frontend
  ports:
    - port: 80
      targetPort: 80
