apiVersion: v1
kind: Namespace
metadata:
  name: urbanops
---
apiVersion: v1
kind: Namespace
metadata:
  name: ingress-nginx
---
apiVersion: v1
kind: Secret
metadata:
  name: postgres-secret
  namespace: urbanops
type: Opaque
stringData:
  POSTGRES_DB: urbanops
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: postgres
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgres-pvc
  namespace: urbanops
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init-sql
  namespace: urbanops
data:
  init-data.sql: |-
    -- Urban Operations Control Center - Database Initialization
    -- Using PLAIN TEXT passwords for simplicity as per requirements

    -- Create tables if they don't exist (to avoid startup errors)

    CREATE TABLE IF NOT EXISTS users (
        id BIGSERIAL PRIMARY KEY,
        username VARCHAR(255) NOT NULL UNIQUE,
        password VARCHAR(255) NOT NULL,
        email VARCHAR(255) UNIQUE
    );

    CREATE TABLE IF NOT EXISTS user_roles (
        user_id BIGINT NOT NULL,
        role VARCHAR(255),
        FOREIGN KEY (user_id) REFERENCES users(id)
    );

    CREATE TABLE IF NOT EXISTS incidents (
        id BIGSERIAL PRIMARY KEY,
        description VARCHAR(255),
        location VARCHAR(255),
        severity VARCHAR(255),
        status VARCHAR(255),
        user_id BIGINT
    );

    CREATE TABLE IF NOT EXISTS alerts (
        id BIGSERIAL PRIMARY KEY,
        title VARCHAR(255),
        message VARCHAR(255),
        priority VARCHAR(255),
        timestamp TIMESTAMP,
        user_id BIGINT
    );

    CREATE TABLE IF NOT EXISTS sensors (
        id BIGSERIAL PRIMARY KEY,
        type VARCHAR(255),
        value DOUBLE PRECISION,
        status VARCHAR(255),
        last_updated TIMESTAMP,
        user_id BIGINT
    );

    CREATE TABLE IF NOT EXISTS cameras (
        id BIGSERIAL PRIMARY KEY,
        name VARCHAR(255),
        location VARCHAR(255),
        status VARCHAR(255),
        stream_url VARCHAR(255),
        last_updated TIMESTAMP,
        user_id BIGINT
    );

    -- Clean up existing data (optional, safe now that tables exist)
    TRUNCATE TABLE incidents, alerts, sensors, cameras, user_roles, users RESTART IDENTITY CASCADE;

    -- Insert Users
    INSERT INTO users (username, password, email) VALUES 
    ('admin', 'password123', 'admin@urbanops.local'),
    ('operator1', 'password123', 'operator1@urbanops.local'),
    ('operator2', 'password123', 'operator2@urbanops.local'),
    ('manager', 'password123', 'manager@urbanops.local'),
    ('viewer', 'password123', 'viewer@urbanops.local');

    -- Insert Roles
    INSERT INTO user_roles (user_id, role) VALUES 
    (1, 'ROLE_ADMIN'),
    (1, 'ROLE_USER'),
    (2, 'ROLE_OPERATOR'),
    (2, 'ROLE_USER'),
    (3, 'ROLE_OPERATOR'),
    (3, 'ROLE_USER'),
    (4, 'ROLE_MANAGER'),
    (4, 'ROLE_USER'),
    (5, 'ROLE_VIEWER'),
    (5, 'ROLE_USER');

    -- Insert Incidents
    -- Admin sees everything (but for now assigning some specifically)
    INSERT INTO incidents (description, location, status, severity, user_id) VALUES
    ('Traffic Accident on MG Road', 'MG Road, Bengaluru', 'ACTIVE', 'HIGH', 1),
    ('Signal Failure in Koramangala', 'Koramangala 5th Block, Bengaluru', 'ACTIVE', 'CRITICAL', 1),
    ('Illegal Parking Crackdown', 'Indiranagar, Bengaluru', 'ACTIVE', 'LOW', 2),
    ('Pothole Reported', 'Whitefield Main Road, Bengaluru', 'PENDING', 'LOW', 2),
    ('Vehicle Breakdown', 'Outer Ring Road, Bengaluru', 'ACTIVE', 'MEDIUM', 3),
    ('Road Construction', 'Hosur Road, Bengaluru', 'PLANNED', 'MEDIUM', 4),
    ('VIP Convoy Escort', 'Airport Road, Bengaluru', 'SCHEDULED', 'HIGH', 5);

    -- Insert Alerts
    INSERT INTO alerts (title, message, priority, timestamp, user_id) VALUES
    ('Congestion in Whitefield', 'Traffic flow below 20km/h in Whitefield', 'HIGH', NOW() - INTERVAL '00:45:00', 1),
    ('System Maintenance', 'Scheduled maintenance at midnight', 'LOW', NOW() - INTERVAL '02:30:00', 1),
    ('Unauthorized Entry', 'Unauthorized vehicle in Electronic City', 'HIGH', NOW() - INTERVAL '01:15:00', 2),
    ('Weather Advisory', 'Heavy rain expected this evening', 'MEDIUM', NOW() - INTERVAL '03:20:00', 4),
    ('Power Surge', 'Substation voltage exceeded 110% in Hebbal', 'CRITICAL', NOW() - INTERVAL '00:25:00', 5);

    -- Insert Sensors
    INSERT INTO sensors (type, value, status, last_updated, user_id) VALUES
    ('traffic', 91.4, 'ONLINE', NOW() - INTERVAL '00:10:00', 1),
    ('environmental', 37.8, 'ONLINE', NOW() - INTERVAL '00:05:00', 1),
    ('traffic', 56.3, 'ONLINE', NOW() - INTERVAL '00:45:00', 2),
    ('environmental', 18.9, 'OFFLINE', NOW() - INTERVAL '01:10:00', 2),
    ('traffic', 73.2, 'ONLINE', NOW() - INTERVAL '00:20:00', 3),
    ('environmental', 9.4, 'WARNING', NOW() - INTERVAL '02:05:00', 3),
    ('traffic', 65.7, 'ONLINE', NOW() - INTERVAL '00:55:00', 4),
    ('environmental', 22.6, 'ONLINE', NOW() - INTERVAL '00:35:00', 4),
    ('traffic', 81.5, 'ONLINE', NOW() - INTERVAL '00:15:00', 5);

    -- Insert Cameras
    INSERT INTO cameras (name, location, status, stream_url, last_updated, user_id) VALUES
    ('Cam-01', 'MG Road Junction, Bengaluru', 'ONLINE', 'rtsp://cam1', NOW(), 1),
    ('Cam-02', 'Koramangala, Bengaluru', 'ONLINE', 'rtsp://cam2', NOW(), 2),
    ('Cam-03', 'Outer Ring Road, Bengaluru', 'OFFLINE', 'rtsp://cam3', NOW(), 3),
    ('Cam-04', 'Whitefield, Bengaluru', 'ONLINE', 'rtsp://cam4', NOW(), 4);
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres
  namespace: urbanops
  labels:
    app: postgres
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
        - name: postgres
          image: postgres:15-alpine
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 5432
          env:
            - name: POSTGRES_DB
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_DB
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_USER
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_PASSWORD
          readinessProbe:
            exec:
              command: ["pg_isready", "-U", "postgres"]
            initialDelaySeconds: 10
            periodSeconds: 10
          volumeMounts:
            - mountPath: /var/lib/postgresql/data
              name: postgres-storage
            - mountPath: /docker-entrypoint-initdb.d/init-data.sql
              name: postgres-init
              subPath: init-data.sql
      volumes:
        - name: postgres-storage
          persistentVolumeClaim:
            claimName: postgres-pvc
        - name: postgres-init
          configMap:
            name: postgres-init-sql
            items:
              - key: init-data.sql
                path: init-data.sql
---
apiVersion: v1
kind: Service
metadata:
  name: postgres
  namespace: urbanops
spec:
  selector:
    app: postgres
  ports:
    - port: 5432
      targetPort: 5432
---
# gateway-service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gateway-service
  namespace: urbanops
  labels:
    app: gateway-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: gateway-service
  template:
    metadata:
      labels:
        app: gateway-service
    spec:
      initContainers:
        - name: wait-for-postgres
          image: busybox:1.28
          command: ['sh', '-c', 'until nc -z postgres.urbanops.svc.cluster.local 5432; do echo waiting for postgres; sleep 2; done']
        - name: wait-for-auth
          image: busybox:1.28
          command: ['sh', '-c', 'until nc -z auth-service.urbanops.svc.cluster.local 8090; do echo waiting for auth-service; sleep 2; done']
      containers:
        - name: gateway-service
          image: nithingowdahm87/hackathon-gateway-service:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8081
          readinessProbe:
            httpGet:
              path: /actuator/health
              port: 8081
            initialDelaySeconds: 60
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /actuator/health
              port: 8081
            initialDelaySeconds: 120
            periodSeconds: 10
          env:
            - name: SPRING_PROFILES_ACTIVE
              value: docker
            - name: SPRING_DATASOURCE_URL
              value: jdbc:postgresql://postgres.urbanops.svc.cluster.local:5432/urbanops
            - name: SPRING_DATASOURCE_USERNAME
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_USER
            - name: SPRING_DATASOURCE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_PASSWORD
---
apiVersion: v1
kind: Service
metadata:
  name: gateway-service
  namespace: urbanops
spec:
  selector:
    app: gateway-service
  ports:
    - port: 8081
      targetPort: 8081
---
# auth-service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: auth-service
  namespace: urbanops
  labels:
    app: auth-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: auth-service
  template:
    metadata:
      labels:
        app: auth-service
    spec:
      containers:
        - name: auth-service
          image: nithingowdahm87/hackathon-auth-service:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8090
          readinessProbe:
            httpGet:
              path: /actuator/health
              port: 8090
            initialDelaySeconds: 60
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /actuator/health
              port: 8090
            initialDelaySeconds: 120
            periodSeconds: 10
          env:
            - name: SPRING_PROFILES_ACTIVE
              value: docker
            - name: SPRING_DATASOURCE_URL
              value: jdbc:postgresql://postgres.urbanops.svc.cluster.local:5432/urbanops
            - name: SPRING_DATASOURCE_USERNAME
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_USER
            - name: SPRING_DATASOURCE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_PASSWORD
---
apiVersion: v1
kind: Service
metadata:
  name: auth-service
  namespace: urbanops
spec:
  selector:
    app: auth-service
  ports:
    - port: 8090
      targetPort: 8090
---
# alert-service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: alert-service
  namespace: urbanops
  labels:
    app: alert-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: alert-service
  template:
    metadata:
      labels:
        app: alert-service
    spec:
      containers:
        - name: alert-service
          image: nithingowdahm87/hackathon-alert-service:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8091
          readinessProbe:
            httpGet:
              path: /actuator/health
              port: 8091
            initialDelaySeconds: 60
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /actuator/health
              port: 8091
            initialDelaySeconds: 120
            periodSeconds: 10
          env:
            - name: SPRING_PROFILES_ACTIVE
              value: docker
            - name: SPRING_DATASOURCE_URL
              value: jdbc:postgresql://postgres.urbanops.svc.cluster.local:5432/urbanops
            - name: SPRING_DATASOURCE_USERNAME
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_USER
            - name: SPRING_DATASOURCE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_PASSWORD
---
apiVersion: v1
kind: Service
metadata:
  name: alert-service
  namespace: urbanops
spec:
  selector:
    app: alert-service
  ports:
    - port: 8091
      targetPort: 8091
---
# cctv-service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cctv-service
  namespace: urbanops
  labels:
    app: cctv-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: cctv-service
  template:
    metadata:
      labels:
        app: cctv-service
    spec:
      containers:
        - name: cctv-service
          image: nithingowdahm87/hackathon-cctv-service:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8094
          readinessProbe:
            httpGet:
              path: /actuator/health
              port: 8094
            initialDelaySeconds: 60
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /actuator/health
              port: 8094
            initialDelaySeconds: 120
            periodSeconds: 10
          env:
            - name: SPRING_PROFILES_ACTIVE
              value: docker
            - name: SPRING_DATASOURCE_URL
              value: jdbc:postgresql://postgres.urbanops.svc.cluster.local:5432/urbanops
            - name: SPRING_DATASOURCE_USERNAME
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_USER
            - name: SPRING_DATASOURCE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_PASSWORD
---
apiVersion: v1
kind: Service
metadata:
  name: cctv-service
  namespace: urbanops
spec:
  selector:
    app: cctv-service
  ports:
    - port: 8094
      targetPort: 8094
---
# power-service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: power-service
  namespace: urbanops
  labels:
    app: power-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: power-service
  template:
    metadata:
      labels:
        app: power-service
    spec:
      containers:
        - name: power-service
          image: nithingowdahm87/hackathon-power-service:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8093
          readinessProbe:
            httpGet:
              path: /actuator/health
              port: 8093
            initialDelaySeconds: 60
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /actuator/health
              port: 8093
            initialDelaySeconds: 120
            periodSeconds: 10
          env:
            - name: SPRING_PROFILES_ACTIVE
              value: docker
            - name: SPRING_DATASOURCE_URL
              value: jdbc:postgresql://postgres.urbanops.svc.cluster.local:5432/urbanops
            - name: SPRING_DATASOURCE_USERNAME
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_USER
            - name: SPRING_DATASOURCE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_PASSWORD
---
apiVersion: v1
kind: Service
metadata:
  name: power-service
  namespace: urbanops
spec:
  selector:
    app: power-service
  ports:
    - port: 8093
      targetPort: 8093
---
# traffic-service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: traffic-service
  namespace: urbanops
  labels:
    app: traffic-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: traffic-service
  template:
    metadata:
      labels:
        app: traffic-service
    spec:
      containers:
        - name: traffic-service
          image: nithingowdahm87/hackathon-traffic-service:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8092
          readinessProbe:
            httpGet:
              path: /actuator/health
              port: 8092
            initialDelaySeconds: 60
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /actuator/health
              port: 8092
            initialDelaySeconds: 120
            periodSeconds: 10
          env:
            - name: SPRING_PROFILES_ACTIVE
              value: docker
            - name: SPRING_DATASOURCE_URL
              value: jdbc:postgresql://postgres.urbanops.svc.cluster.local:5432/urbanops
            - name: SPRING_DATASOURCE_USERNAME
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_USER
            - name: SPRING_DATASOURCE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_PASSWORD
---
apiVersion: v1
kind: Service
metadata:
  name: traffic-service
  namespace: urbanops
spec:
  selector:
    app: traffic-service
  ports:
    - port: 8092
      targetPort: 8092
---
# python-service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: python-service
  namespace: urbanops
  labels:
    app: python-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: python-service
  template:
    metadata:
      labels:
        app: python-service
    spec:
      containers:
        - name: python-service
          image: nithingowdahm87/hackathon-python-service:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8000
          readinessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 30
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 60
            periodSeconds: 10
          env:
            - name: DATABASE_URL
              value: postgresql://postgres:postgres@postgres.urbanops.svc.cluster.local:5432/urbanops
            - name: WEATHER_API_URL
              value: https://api.open-meteo.com/v1/forecast
            - name: BACKEND_API_URL
              value: http://gateway-service.urbanops.svc.cluster.local:8081/api/predictions
---
apiVersion: v1
kind: Service
metadata:
  name: python-service
  namespace: urbanops
spec:
  selector:
    app: python-service
  ports:
    - port: 8000
      targetPort: 8000
---
# frontend
apiVersion: v1
kind: ConfigMap
metadata:
  name: frontend-config
  namespace: urbanops
data:
  config.json: |
    {
      "API_URL": "/api"
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
  namespace: urbanops
  labels:
    app: frontend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      containers:
        - name: frontend
          image: nithingowdahm87/hackathon-frontend:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 3000
          readinessProbe:
            httpGet:
              path: /health
              port: 3000
            initialDelaySeconds: 30
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /health
              port: 3000
            initialDelaySeconds: 60
            periodSeconds: 10
          volumeMounts:
            - name: config
              mountPath: /usr/share/nginx/html/config.json
              subPath: config.json
      volumes:
        - name: config
          configMap:
            name: frontend-config
---
apiVersion: v1
kind: Service
metadata:
  name: frontend
  namespace: urbanops
spec:
  selector:
    app: frontend
  ports:
    - port: 3000
      targetPort: 3000
